machine:
    node:
        version: 8.7.0
    services:
        - docker
    environment:
        GOROOT: ""
        GOPATH: "${HOME}/.go_project"
        PATH: "${GOPATH}/bin:${PATH}"
        BUILD_PATH: "${GOPATH}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

dependencies:
    pre:
        - rm -rf ~/.go_workspace
        - go get -u github.com/FiloSottile/gvt
        - npm install -g @angular/cli
    override:
        - mkdir -p ~/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}
        - ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} ${BUILD_PATH}
        - go get -d -v
        - make vendor 

test:
    override:
        - cd $BUILD_PATH && make test

compile:
    override:
        - cd $BUILD_PATH && make build

deployment:
    development:
        branch: master
        commands:
            - cd $BUILD_PATH && make docker
    testing:
        branch: testing
        commands:
            - cd $BUILD_PATH && make docker
    stage:
        branch: stage
        commands:
            - cd $BUILD_PATH && make docker
    production:
        branch: production
        commands:
            - cd $BUILD_PATH && make docker
